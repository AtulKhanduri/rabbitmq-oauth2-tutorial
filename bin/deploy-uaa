#!/usr/bin/env bash

SCRIPT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

MODE=${MODE:-asymmetric_key}
<<<<<<< HEAD
UAA=${UAA:-4.24.0}  
=======
UAA_IMAGE_TAG=${UAA_IMAGE_TAG:-4.24.0}  # 4.24.0
UAA_IMAGE=uaa
>>>>>>> Use Case 9 Use custom scopes

docker network inspect rabbitmq_net >/dev/null 2>&1 || docker network create rabbitmq_net
docker rm -f uaa 2>/dev/null || echo "uaa was not running"

<<<<<<< HEAD
=======
cp ${SCRIPT}/../conf/${MODE}/uaa-${UAA_IMAGE_TAG}.yml ${SCRIPT}/../conf/${MODE}/uaa.yml

>>>>>>> Use Case 9 Use custom scopes
docker run \
		--detach \
    --name uaa --net rabbitmq_net \
		--publish 8080:8080 \
<<<<<<< HEAD
    -v ${SCRIPT}/../conf/${MODE}:/config \
    --env CLOUDFOUNDRY_CONFIG_PATH=/config \
    --env CLOUD_FOUNDRY_CONFIG_PATH=/config \
    uaa:${UAA}

#    --env LOGGING_CONFIG=/config/log4j2.properties \
#		--env spring_profiles=default,hsqldb,logging \

echo "Running uaa:${UAA} docker image with ${MODE}..."
=======
    --mount type=bind,source=${SCRIPT}/../conf/${MODE},target=/etc/uaa \
    --mount type=bind,source=${SCRIPT}/../conf/${MODE},target=/config \
    --env CLOUDFOUNDRY_CONFIG_PATH=/config \
    --env CLOUD_FOUNDRY_CONFIG_PATH=/config \
		--env JAVA_OPTS="-Djava.security.egd=file:/dev/./urandom" \
    ${UAA_IMAGE}:${UAA_IMAGE_TAG}

#    --env LOGGING_CONFIG=/config/log4j2.properties \
#		--env spring_profiles=default,hsqldb,logging \
#    --env spring_profiles=default,hsqldb,logging \
#    --env LOGGING_CONFIG=/config/log4j2.properties \

echo "Running uaa:${UAA_IMAGE_TAG} docker image with ${MODE}..."
>>>>>>> Use Case 9 Use custom scopes
echo " "
echo "Monitor the logs (docker logs uaa -f). UAA will be ready when you see 'Task :cargoRunLocal' "
echo "Once UAA is ready; run 'make setup-users-and-tokens' before starting any application and/or rabbitmq"
